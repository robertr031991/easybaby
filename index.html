<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>EasyBaby</title>
  <meta name="color-scheme" content="light dark" />
  <style>
    :root { 
      --bg: #f9fafb; 
      --card: #ffffff; 
      --text: #111827; 
      --muted: #6b7280; 
      --line: #e5e7eb; 
      --brand: #b45309; 
    }
    * { box-sizing: border-box; }
    body { 
      margin: 0; 
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, sans-serif; 
      background: var(--bg); 
      color: var(--text); 
    }
    .wrap { max-width: 860px; margin: 0 auto; padding: 24px; }
    .card { 
      background: var(--card); 
      border: 1px solid var(--line); 
      border-radius: 14px; 
      padding: 20px; 
      box-shadow: 0 2px 8px rgba(0,0,0,.06); 
    }
    h1 { margin: 0 0 8px; font-size: 22px; }
    h2 { margin: 16px 0 10px; font-size: 18px; }
    p { margin: 0 0 14px; color: var(--muted); }
    label { 
      display: block; 
      font-size: 12px; 
      color: var(--muted); 
      margin-bottom: 6px; 
    }
    input, select, textarea { 
      width: 100%; 
      padding: 10px 12px; 
      border: 1px solid var(--line); 
      border-radius: 10px; 
      font-size: 14px; 
      background: #fff; 
    }
    textarea { min-height: 72px; resize: vertical; }
    button { 
      appearance: none; 
      border: none; 
      background: var(--brand); 
      color: #fff; 
      padding: 10px 14px; 
      border-radius: 10px; 
      font-weight: 600; 
      cursor: pointer; 
    }
    .btn-ghost { 
      background: #fff; 
      color: #374151; 
      border: 1px solid var(--line); 
    }
    .row { display: flex; gap: 10px; align-items: center; }
    .between { 
      display: flex; 
      justify-content: space-between; 
      align-items: center; 
      gap: 12px; 
    }
    .grid { display: grid; gap: 12px; }
    .grid-2 { grid-template-columns: 1fr 1fr; }
    .mt-1 { margin-top: 6px; }
    .mt-2 { margin-top: 8px; }
    .mt-3 { margin-top: 12px; }
    .mt-4 { margin-top: 16px; }
    .muted { color: var(--muted); font-size: 13px; }
    .hidden { display: none; }
    .list { display: grid; gap: 10px; }
    .item { 
      padding: 12px 14px; 
      border: 1px solid var(--line); 
      border-radius: 12px; 
      background: #fff; 
    }
    .pill { 
      background: #fff7ed; 
      color: #9a3412; 
      border: 1px solid #fed7aa; 
      padding: 4px 8px; 
      border-radius: 999px; 
      font-size: 12px; 
    }
    .badge { 
      font-size: 12px; 
      padding: 3px 8px; 
      border-radius: 999px; 
      border: 1px solid var(--line); 
      background: #fff; 
    }
    .ok { color: #065f46; }
    .err { color: #b91c1c; }
    .note { 
      font-size: 12px; 
      background: #fff; 
      border: 1px dashed #e5e7eb; 
      padding: 8px 10px; 
      border-radius: 8px; 
      margin-top: 8px; 
    }
    .tabs { display: flex; gap: 8px; margin: 10px 0 16px; }
    .tab-btn { 
      background: #fff; 
      color: #374151; 
      border: 1px solid var(--line); 
      padding: 8px 12px; 
      border-radius: 999px; 
      cursor: pointer; 
    }
    .tab-btn.active { 
      background: #111827; 
      color: #fff; 
      border-color: #111827; 
    }
  </style>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';

    const SUPABASE_URL = 'https://mfgdasfnidxxzcymfvfx.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1mZ2Rhc2ZuaWR4eHpjeW1mdmZ4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY0NzYxNTksImV4cCI6MjA3MjA1MjE1OX0.hMk0myq85kUDUB-RXvb-Y5Xg36lLFWryVOi34x3ahYU';
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const ACTIVE_KEY = 'easybaby.activeBabyId';
    let currentUser = null;

    function setDefaultTimezone() {
      try { 
        const tz = Intl.DateTimeFormat().resolvedOptions().timeZone || 'America/New_York';
        document.getElementById('baby-tz').value = tz;
      } catch { 
        document.getElementById('baby-tz').value = 'America/New_York'; 
      }
    }

    async function consumeAuthFromUrl() {
      const url = new URL(window.location.href);

      const code = url.searchParams.get('code');
      if (code) {
        try { 
          await supabase.auth.exchangeCodeForSession(code); 
        } catch (e) { 
          console.warn('exchangeCodeForSession', e); 
        }
        url.searchParams.delete('code');
        url.searchParams.delete('state');
      }

      const token_hash = url.searchParams.get('token_hash');
      const type = url.searchParams.get('type');
      const email = url.searchParams.get('email');
      if (token_hash && type) {
        try { 
          await supabase.auth.verifyOtp({ type, token_hash, email }); 
        } catch (e) { 
          console.warn('verifyOtp', e); 
        }
        ['token_hash','type','email'].forEach(p => url.searchParams.delete(p));
      }

      if (location.hash.includes('access_token')) {
        const hash = new URLSearchParams(location.hash.slice(1));
        const access_token = hash.get('access_token');
        const refresh_token = hash.get('refresh_token');
        if (access_token && refresh_token) {
          try { 
            await supabase.auth.setSession({ access_token, refresh_token }); 
          } catch (e) { 
            console.warn('setSession', e); 
          }
        }
        history.replaceState({}, '', url.pathname + url.search);
      } else {
        history.replaceState({}, '', url.pathname + url.search);
      }
    }

    async function init() {
      await consumeAuthFromUrl();

      try {
        const sessionPromise = supabase.auth.getSession();
        const timeoutPromise = new Promise((_, reject) => 
          setTimeout(() => reject(new Error('Session timeout')), 3000)
        );
        
        const result = await Promise.race([sessionPromise, timeoutPromise]);
        const session = result.data?.session;
        if (session?.user) {
          currentUser = session.user;
        }
      } catch (e) {
        console.log('Session check timed out, relying on auth events');
      }

      updateAuthView(!!currentUser);

      if (currentUser) {
        document.getElementById('whoami').textContent = 'Signed in as: ' + currentUser.email;
        await loadBabies();
        await refreshActiveHeader();
      }

      switchTab(location.hash === '#settings' ? 'settings' : 'activity');
    }

    function updateAuthView(signedIn) {
      document.getElementById('view-signed-out').classList.toggle('hidden', signedIn);
      document.getElementById('view-signed-in').classList.toggle('hidden', !signedIn);
      document.getElementById('view-email-sent').classList.add('hidden');
      document.getElementById('tabs').classList.toggle('hidden', !signedIn);
    }

    supabase.auth.onAuthStateChange(async (event, session) => {
      console.log('Auth state changed:', event, !!session);
      if (session?.user) {
        currentUser = session.user;
      } else {
        currentUser = null;
      }
      
      updateAuthView(!!session);
      if (session) { 
        await init(); 
      } else { 
        document.getElementById('whoami').textContent = '';
        currentUser = null;
      }
    });

    function switchTab(name) {
      document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
      const btn = document.querySelector('[data-tab="' + name + '"]');
      if (btn) btn.classList.add('active');
      
      document.getElementById('tab-activity').classList.add('hidden');
      document.getElementById('tab-settings').classList.add('hidden');
      
      if (name === 'activity') { 
        document.getElementById('tab-activity').classList.remove('hidden'); 
        location.hash = '#activity'; 
      } else { 
        document.getElementById('tab-settings').classList.remove('hidden'); 
        location.hash = '#settings'; 
      }
    }

    async function sendLink(e) {
      e.preventDefault();
      const statusEl = document.getElementById('status');
      statusEl.textContent = 'Sending magic link...';
      
      const email = document.getElementById('email').value.trim();
      if (!email) { 
        statusEl.textContent = 'Enter an email.'; 
        return; 
      }
      
      try {
        const result = await supabase.auth.signInWithOtp({
          email: email,
          options: { emailRedirectTo: window.location.origin }
        });
        
        if (result.error) {
          statusEl.textContent = 'Error: ' + result.error.message;
        } else { 
          statusEl.textContent = ''; 
          document.getElementById('view-signed-out').classList.add('hidden'); 
          document.getElementById('view-email-sent').classList.remove('hidden'); 
        }
      } catch (err) {
        statusEl.textContent = 'Error: ' + err.message;
      }
    }

    async function logout() { 
      await supabase.auth.signOut(); 
      switchTab('activity'); 
    }

    async function loadBabies() {
      try {
        const result = await supabase
          .from('babies')
          .select('id,name,dob,timezone')
          .order('dob', { ascending: false });
        
        if (result.error) throw result.error;
        
        const data = result.data || [];
        const babyList = document.getElementById('baby-list');
        const activeId = localStorage.getItem(ACTIVE_KEY);
        
        if (data.length === 0) {
          babyList.innerHTML = '<div class="muted">No babies yet. Create one above.</div>';
        } else {
          babyList.innerHTML = data.map(baby => {
            const isActive = baby.id === activeId;
            return '<div class="item" data-baby="' + baby.id + '">' +
              '<div>' +
                '<div><strong>' + baby.name + '</strong> <span class="muted">DOB: ' + baby.dob + '</span></div>' +
                '<div class="muted">TZ: ' + baby.timezone + '</div>' +
              '</div>' +
              '<div class="row">' +
                (isActive ? '<span class="pill active-badge">Active</span>' : '<span class="active-badge hidden pill">Active</span>') +
                '<button onclick="easybaby.setActive(\'' + baby.id + '\')">Set Active</button>' +
              '</div>' +
            '</div>';
          }).join('');
        }
      } catch (err) {
        console.error('Error loading babies:', err);
      }
    }

    async function createBaby(e) {
      e.preventDefault();
      if (!currentUser) return;
      
      const btn = document.getElementById('create-baby-btn');
      const msg = document.getElementById('create-msg');
      const name = document.getElementById('baby-name').value.trim();
      const dob = document.getElementById('baby-dob').value;
      const timezone = document.getElementById('baby-tz').value.trim() || 'America/New_York';
      
      if (!name || !dob) {
        msg.textContent = 'Enter name and DOB.';
        msg.className = 'err';
        return;
      }
      
      btn.disabled = true;
      const prevText = btn.textContent;
      btn.textContent = 'Saving...';
      msg.textContent = '';
      msg.className = 'muted';
      
      try {
        const result = await supabase
          .from('babies')
          .insert([{
            owner_id: currentUser.id,
            name: name,
            dob: dob,
            timezone: timezone
          }]);
        
        if (result.error) throw result.error;
        
        msg.textContent = 'Saved!';
        msg.className = 'ok';
        document.getElementById('baby-name').value = '';
        document.getElementById('baby-dob').value = '';
        
        await loadBabies();
        await refreshActiveHeader();
      } catch (err) {
        msg.textContent = 'Error: ' + err.message;
        msg.className = 'err';
      } finally {
        btn.disabled = false;
        btn.textContent = prevText;
      }
    }

    async function refreshActiveHeader() {
      const id = localStorage.getItem(ACTIVE_KEY);
      const activeNameEl = document.getElementById('active-baby-name');
      
      if (!id) { 
        activeNameEl.textContent = 'No active baby — set one in Settings.'; 
        return; 
      }
      
      try {
        const result = await supabase.from('babies').select('name').eq('id', id).single();
        if (result.error || !result.data) { 
          activeNameEl.textContent = 'Active baby not found'; 
          return; 
        }
        activeNameEl.textContent = result.data.name;
      } catch (err) {
        activeNameEl.textContent = 'Active baby not found';
      }
    }

    function setActive(id) {
      localStorage.setItem(ACTIVE_KEY, id);
      document.querySelectorAll('.active-badge').forEach(el => el.classList.add('hidden'));
      const badge = document.querySelector('[data-baby="' + id + '"] .active-badge');
      if (badge) badge.classList.remove('hidden');
      refreshActiveHeader();
      switchTab('activity');
    }

    // Global functions
    window.easybaby = {
      sendLink: sendLink,
      logout: logout,
      switchTab: switchTab,
      createBaby: createBaby,
      setActive: setActive
    };

    // Initialize
    setDefaultTimezone();
    init();
  </script>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>EasyBaby</h1>
      <p class="muted">Log daily activities on the <strong>Activity</strong> tab. Manage profiles on <strong>Settings</strong>.</p>

      <div class="tabs hidden" id="tabs">
        <button class="tab-btn" data-tab="activity" onclick="easybaby.switchTab('activity')">Activity</button>
        <button class="tab-btn" data-tab="settings" onclick="easybaby.switchTab('settings')">Settings</button>
      </div>

      <!-- Signed OUT -->
      <form id="view-signed-out" onsubmit="easybaby.sendLink(event)">
        <input id="email" type="email" placeholder="you@example.com" required />
        <div class="row mt-3">
          <button type="submit">Send Magic Link</button>
          <span id="status" class="muted"></span>
        </div>
      </form>

      <!-- Email SENT -->
      <div id="view-email-sent" class="hidden mt-4">
        <p>Check your email for the magic link. Open it on this device.</p>
      </div>

      <!-- Signed IN -->
      <div id="view-signed-in" class="hidden mt-2">
        <div id="whoami" class="note"></div>

        <!-- ACTIVITY TAB -->
        <section id="tab-activity">
          <div class="between">
            <h2>Active Baby: <span id="active-baby-name" class="muted">No active baby — set one in Settings.</span></h2>
          </div>
          <p class="muted">Activity tracking coming soon...</p>
        </section>

        <!-- SETTINGS TAB -->
        <section id="tab-settings" class="hidden">
          <h2>Create Baby</h2>
          <form onsubmit="easybaby.createBaby(event)">
            <div class="mt-2">
              <label for="baby-name">Name</label>
              <input id="baby-name" type="text" placeholder="e.g., Emma" required />
            </div>
            <div class="mt-2">
              <label for="baby-dob">Date of Birth</label>
              <input id="baby-dob" type="date" required />
            </div>
            <div class="mt-2">
              <label for="baby-tz">Timezone</label>
              <input id="baby-tz" type="text" placeholder="America/New_York" />
            </div>
            <div class="row mt-3">
              <button id="create-baby-btn" type="submit">Create Baby</button>
              <span id="create-msg" class="muted"></span>
            </div>
          </form>

          <h2 class="mt-4">Your Babies</h2>
          <div id="baby-list" class="list"></div>

          <div class="mt-4">
            <button onclick="easybaby.logout()">Sign out</button>
          </div>
        </section>
      </div>
    </div>
  </div>
</body>
</html>
